<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="index, follow" />
  <meta name="author" content="Alex Salom" />
  <meta name="keywords" content="ios, engineer, developer, tech, tdd, unit testing, code, clean code" />
  <!-- Begin Jekyll SEO tag v2.3.0 -->
<title>Dependency Injection with Service Locator | a dev’s journal</title>
<meta property="og:title" content="Dependency Injection with Service Locator" />
<meta name="author" content="Alex Salom" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Here at WeltN24’s iOS team we like to test. We like it so much that we build our code to be almost 100% testable. We are able to achieve this by injecting all dependencies through each class’ initializer. One technic to do this is to make use of Swift’s default values. The Swift Programming Language You can define a default value for any parameter in a function by assigning a value to the parameter after that parameter’s type. If a default value is defined, you can omit that parameter when calling the function." />
<meta property="og:description" content="Here at WeltN24’s iOS team we like to test. We like it so much that we build our code to be almost 100% testable. We are able to achieve this by injecting all dependencies through each class’ initializer. One technic to do this is to make use of Swift’s default values. The Swift Programming Language You can define a default value for any parameter in a function by assigning a value to the parameter after that parameter’s type. If a default value is defined, you can omit that parameter when calling the function." />
<link rel="canonical" href="http://localhost:3000/2017/03/03/dependency-injection-with-service-locator/" />
<meta property="og:url" content="http://localhost:3000/2017/03/03/dependency-injection-with-service-locator/" />
<meta property="og:site_name" content="a dev’s journal" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-03-03T00:00:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@empatiia" />
<meta name="twitter:creator" content="@Alex Salom" />
<script type="application/ld+json">
{"headline":"Dependency Injection with Service Locator","dateModified":"2017-03-03T00:00:00+01:00","datePublished":"2017-03-03T00:00:00+01:00","sameAs":null,"author":{"@type":"Person","name":"Alex Salom"},"description":"Here at WeltN24’s iOS team we like to test. We like it so much that we build our code to be almost 100% testable. We are able to achieve this by injecting all dependencies through each class’ initializer. One technic to do this is to make use of Swift’s default values. The Swift Programming Language You can define a default value for any parameter in a function by assigning a value to the parameter after that parameter’s type. If a default value is defined, you can omit that parameter when calling the function.","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:3000/static/img/profile.jpg"},"name":"Alex Salom"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:3000/2017/03/03/dependency-injection-with-service-locator/"},"name":null,"@type":"BlogPosting","image":null,"url":"http://localhost:3000/2017/03/03/dependency-injection-with-service-locator/","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <!-- Schema.org markup for Google+ -->
  <meta itemprop="name" content="Dependency Injection with Service Locator">
  <meta itemprop="description" content="This is the blog and personal site of Alex Salom, a professional iOS developer with a background in Software Engineering.">
  <meta itemprop="image" content="/static/img/profile.jpg">


  <link rel="favicon" href="/static/img/favicon/favicon.ico">
  <link rel="apple-touch-icon" sizes="57x57" href="/static/img/favicon/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/static/img/favicon/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/static/img/favicon/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/static/img/favicon/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/static/img/favicon/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/static/img/favicon/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/static/img/favicon/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/static/img/favicon/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/img/favicon/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/static/img/favicon/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/img/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/static/img/favicon/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/img/favicon/favicon-16x16.png">
  <!--<link rel="manifest" href="/static/img/manifest.json">-->
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/static/img/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">



  <!-- Bootstrap -->
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet"
  integrity="sha256-MfvZlkHCEqatNoGiOXveE8FIwMzZg4W85qfrfIFBfYc= sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ=="
  crossorigin="anonymous">

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->

  <!-- Custom styles for this template -->
  <link rel="stylesheet" type="text/css" href="/static/css/main.css" />
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,400,200bold,400old" />
  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" />
  <link rel="stylesheet" type="text/css" href="/static/css/syntax.css" />

  <!-- Google Analytics -->
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42771965-1', 'auto');
  ga('send', 'pageview');

</script>
</head>
<!-- Main Body-->
<body>
  <!-- Wrap all page content here -->
  <div id="wrap">
    <!-- Navbar header -->
    <nav class="navbar navbar-default">
  <div class="container">
    <div class="navbar-header">
      <a class="navbar-brand" href="/"><i class="fa fa-home"></i></a>
    </div>
    <div id="navbar">
      <ul class="nav navbar-nav navbar-right">
      	<li><a href="/">journal</a></li>
        <li><a href="/about">about</a></li>
        <li><a href="/projects">projects</a></li>
        <!--<li><a href="http://biomadeira.github.io/vitae">RESUME</a></li>-->
      </ul>
    </div>
  </div>
</nav>

    <div class="container">
	<div class="blog-post">
		<h3>
		  <strong><a href="/2017/03/03/dependency-injection-with-service-locator/">Dependency Injection with Service Locator</a></strong>
		</h3>
	</div>
	<div class="blog-title">
		<h4>
		March  3, 2017
			&nbsp;&nbsp;
			
			 <span class="label label-success">Swift</span>
			
			 <span class="label label-success">Unit Testing</span>
			
			 <span class="label label-success">Dependency Injection</span>
			
			 <span class="label label-success">Blog</span>
			
		</h4>
	</div>
	<div class="panel panel-default">
		<div class="panel-body">
			<div class="blogpost">
			  <p>Here at <a href="http://welt.de">WeltN24</a>’s iOS team we like to test. We like it so much that we build our code to be <del>almost</del> 100% testable. We are able to achieve this by injecting all dependencies through each class’ initializer. One technic to do this is to make use of Swift’s default values.</p>
<blockquote>
  <p><a href="https://developer.apple.com/library/content/documentation/Swift/Conceptual/Swift_Programming_Language/Functions.html">The Swift Programming Language</a></p>

  <p>You can define a default value for any parameter in a function by assigning a value to the parameter after that parameter’s type. If a default value is defined, you can omit that parameter when calling the function.</p>
</blockquote>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">hello</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"Alex Salom"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">String</span> <span class="p">{</span>
  <span class="k">return</span> <span class="s">"Hello </span><span class="se">\(</span><span class="n">name</span><span class="se">)</span><span class="s">"</span>
<span class="p">}</span>

<span class="nf">hello</span><span class="p">()</span> <span class="c1">// Hello Alex Salom</span>
<span class="nf">hello</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"Nick Cave"</span><span class="p">)</span> <span class="c1">// Hello Nick Cave</span>
</code></pre></div></div>

<p>Let’s say that we have an object called <code class="highlighter-rouge">PeopleManager</code> who’s purpose is to, well, manage people. Let’s imagine that it can fetch people from the network and save people in a database. Since we like to follow the <a href="https://en.wikipedia.org/wiki/Single_responsibility_principle">Single Responsibility Principle</a>, we want these two functionalities to be encapsulated in different objects, <code class="highlighter-rouge">Fetcher</code> and <code class="highlighter-rouge">Database</code>.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protocol</span> <span class="kt">Database</span> <span class="p">{</span>
  <span class="kd">func</span> <span class="nf">save</span><span class="p">(</span><span class="nv">person</span><span class="p">:</span> <span class="kt">Person</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">DatabaseImpl</span><span class="p">:</span> <span class="kt">Database</span> <span class="p">{</span> <span class="o">...</span><span class="err"> </span><span class="p">}</span>

<span class="kd">protocol</span> <span class="kt">Fetcher</span> <span class="p">{</span>
  <span class="kd">func</span> <span class="nf">fetch</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Person</span>
<span class="p">}</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">FetcherImpl</span><span class="p">:</span> <span class="kt">Fetcher</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>

</code></pre></div></div>

<p>Using Swift’s default values we could inject those dependencies into <code class="highlighter-rouge">PeopleManager</code> like this:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="kd">class</span> <span class="kt">PeopleManager</span> <span class="p">{</span>
  <span class="kd">private</span> <span class="k">let</span> <span class="nv">database</span><span class="p">:</span> <span class="kt">Database</span>
  <span class="kd">private</span> <span class="k">let</span> <span class="nv">fetcher</span><span class="p">:</span> <span class="kt">Fetcher</span>

  <span class="nf">init</span><span class="p">(</span><span class="nv">database</span><span class="p">:</span> <span class="kt">Database</span> <span class="o">=</span> <span class="kt">DatabaseImpl</span><span class="p">(),</span> <span class="nv">fetcher</span><span class="p">:</span> <span class="kt">Fetcher</span> <span class="o">=</span> <span class="kt">FetcherImpl</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>
    <span class="k">self</span><span class="o">.</span><span class="n">fetcher</span> <span class="o">=</span> <span class="n">fetcher</span>
  <span class="p">}</span>

  <span class="kd">func</span> <span class="nf">person</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Person</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">fetcher</span><span class="o">.</span><span class="nf">fetch</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="kd">func</span> <span class="nf">addPerson</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">person</span> <span class="o">=</span> <span class="kt">Person</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"Alex Salom"</span><span class="p">)</span>
    <span class="n">database</span><span class="o">.</span><span class="nf">save</span><span class="p">(</span><span class="nv">person</span><span class="p">:</span> <span class="n">person</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This is very nice as it allows us to initialize <code class="highlighter-rouge">PeopleManager</code> through its empty initializer from the production code <code class="highlighter-rouge">PeopleManager()</code> but giving us the possibility to inject mocked versions of the dependencies from the tests <code class="highlighter-rouge">PeopleManager(database: DatabaseMock(), fetcher: FetcherMock())</code>.</p>

<p>However we did find one issue with this technic. When an object has quite a few dependencies, the initializer can get out of hands having long signatures. That’s why we came up with something called <code class="highlighter-rouge">ServiceLocator</code>. We can think of a <code class="highlighter-rouge">ServiceLocator</code> as a registry of dependencies for a given object. The idea is that each dependency will declare its own locator so other objects can find a way to initialize those dependencies. Let’s see an example with our <code class="highlighter-rouge">Database</code>.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protocol</span> <span class="kt">Database</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="kt">DatabaseImpl</span><span class="p">:</span> <span class="kt">Database</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>

<span class="kd">protocol</span> <span class="kt">DatabaseLocator</span> <span class="p">{</span>
  <span class="kd">func</span> <span class="nf">database</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Database</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">DatabaseLocator</span> <span class="p">{</span>
  <span class="kd">func</span> <span class="nf">database</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Database</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kt">DatabaseImpl</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We declared a protocol <code class="highlighter-rouge">DatabaseLocator</code> with a function that will provide us with an instance of <code class="highlighter-rouge">Database</code>. We also declared a protocol extension with a default implementation of that function. Now imagine we did the same for <code class="highlighter-rouge">Fetcher</code> and we now have a <code class="highlighter-rouge">FetcherLocator</code> as well as a <code class="highlighter-rouge">DatabaseLocator</code>. With those in place let’s revisit <code class="highlighter-rouge">PeopleManger</code>’s dependency injection.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="kd">class</span> <span class="kt">PeopleManager</span> <span class="p">{</span>
  <span class="kd">typealias</span> <span class="kt">ServiceLocator</span> <span class="o">=</span> <span class="kt">DatabaseLocator</span> <span class="o">&amp;</span> <span class="kt">FetcherLocator</span>
  <span class="kd">final</span> <span class="kd">class</span> <span class="kt">ServiceLocatorImpl</span><span class="p">:</span> <span class="kt">ServiceLocator</span> <span class="p">{}</span>

  <span class="kd">private</span> <span class="k">let</span> <span class="nv">database</span><span class="p">:</span> <span class="kt">Database</span>
  <span class="kd">private</span> <span class="k">let</span> <span class="nv">fetcher</span><span class="p">:</span> <span class="kt">Fetcher</span>

  <span class="nf">init</span><span class="p">(</span><span class="nv">serviceLocator</span><span class="p">:</span> <span class="kt">ServiceLocator</span> <span class="o">=</span> <span class="kt">ServiceLocatorImpl</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">serviceLocator</span><span class="o">.</span><span class="nf">database</span><span class="p">()</span>
    <span class="k">self</span><span class="o">.</span><span class="n">fetcher</span> <span class="o">=</span> <span class="n">serviceLocator</span><span class="o">.</span><span class="nf">fetcher</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="kd">func</span> <span class="nf">person</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Person</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">fetcher</span><span class="o">.</span><span class="nf">fetch</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="kd">func</span> <span class="nf">addPerson</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">person</span> <span class="o">=</span> <span class="kt">Person</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"Nick Cave"</span><span class="p">)</span>
    <span class="n">database</span><span class="o">.</span><span class="nf">save</span><span class="p">(</span><span class="nv">person</span><span class="p">:</span> <span class="n">person</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We start by declaring a <code class="highlighter-rouge">typealias ServiceLocator</code> with all the dependencies of this class. This is very convenient because only by looking at this line we see all the objects <code class="highlighter-rouge">PeopleManager</code> depends on. We then inject the <code class="highlighter-rouge">ServiceLocator</code> into the initializer <code class="highlighter-rouge">init(serviceLocator: ServiceLocator = ServiceLocatorImpl())</code> using a default value of <code class="highlighter-rouge">ServiceLocatorImpl</code>.
<code class="highlighter-rouge">ServiceLocatorImpl</code> doesn’t need to provide any implementation because each one of the Locators have provided an extension to every method they declare. We just found a way to inject as many dependencies as we want by declaring only one variable at <code class="highlighter-rouge">PeopleManager</code>’s initializer. Since all the dependencies use protocols and the locators are protocols themselves we could now build our own version of ServiceLocator that returns mocked objects and inject those from the tests.</p>

<p>Schönes Wochenende!</p>

<p><a href="https://github.com/asalom/alexsalom.es/tree/master/_code/2017-03-03-dependency-injection-with-service-locator">Get the code here</a></p>

			   <hr>
			   <div class="related-posts">
				   <h5>Related Posts</h5>
				   
						<div class="row">
							 <div class="col-sm-4 col-md-4 col-lg-4">
								 <h6 style="text-align: right">
								 	September 29, 2017
								 </h6>
							 </div>
							 <div class="col-sm-8 col-md-8 col-lg-8">
								 <h6 style="text-align: left">
								 	<strong><a href="/2017/09/29/localize+strings+extension/">Localize strings more beautifully with an extension</a></strong>
								 </h6>
							 </div>
						</div>
					
						<div class="row">
							 <div class="col-sm-4 col-md-4 col-lg-4">
								 <h6 style="text-align: right">
								 	March 10, 2016
								 </h6>
							 </div>
							 <div class="col-sm-8 col-md-8 col-lg-8">
								 <h6 style="text-align: left">
								 	<strong><a href="/2016/03/10/swap-out-your-appdelegate-for-testing/">Swap out your App Delegate for testing</a></strong>
								 </h6>
							 </div>
						</div>
					
						<div class="row">
							 <div class="col-sm-4 col-md-4 col-lg-4">
								 <h6 style="text-align: right">
								 	March  6, 2016
								 </h6>
							 </div>
							 <div class="col-sm-8 col-md-8 col-lg-8">
								 <h6 style="text-align: left">
								 	<strong><a href="/2016/03/06/who-am-i/">Who am I?</a></strong>
								 </h6>
							 </div>
						</div>
					
			   </div>
			</div>
		</div>
	</div>
	

</div>


  </div>
  <!-- Footer -->
  <footer>
    <div id="footer">
        <div class="container">
            <p class="text-muted">© All rights reserved. Powered by <a href="http://jekyllrb.com/">Jekyll</a> and
            <a href="http://www.github.com/biomadeira/sustain">sustain</a> with ♥</p>
        </div>
    </div>
</footer>
<div class="footer"></div>

  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <!-- Bootstrap core JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"
  integrity="sha256-Sk3nkD6mLTMOF0EOpNtsIry+s1CsaqQC1rVLTAy+0yc= sha512-K1qjQ+NcF2TYO/eI3M6v8EiNYZfA95pQumfvcVrTHtwQVDG+aHRqLi/ETn2uB+1JqwYqVG3LIvdm9lj6imS/pQ=="
  crossorigin="anonymous"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="/static/js/docs.min.js"></script>
  <script src="/static/js/main.js"></script>
  <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
  <script src="/static/js/ie10-viewport-bug-workaround.js"></script>
</body>
</html>
